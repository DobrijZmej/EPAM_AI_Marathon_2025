<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI –ê–≥–µ–Ω—Ç –ø—ñ–¥—Ç—Ä–∏–º–∫–∏</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.2.0/dist/amazon-cognito-identity.min.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .container { max-width: 800px; margin-top: 40px; }
    .response-box { min-height: 100px; background-color: #fff; padding: 15px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .status { margin-left: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center mb-4">AI –ê–≥–µ–Ω—Ç –ø—ñ–¥—Ç—Ä–∏–º–∫–∏</h2>

    <!-- üîê –ë–ª–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó -->
    <div id="auth-block" class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</h5>

        <div class="row">
          <div class="col-md-6">
            <input class="form-control mb-2" id="reg_email" placeholder="Email –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó">
            <input class="form-control mb-2" id="reg_password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn btn-primary" onclick="register()">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
            <span id="registerStatus" class="status"></span>
          </div>

          <div class="col-md-6">
            <input class="form-control mb-2" id="confirm_email" placeholder="Email">
            <input class="form-control mb-2" id="confirm_code" placeholder="–ö–æ–¥ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è">
            <button class="btn btn-success" onclick="confirmEmail()">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ email</button>
            <span id="confirmStatus" class="status"></span>
          </div>
        </div>

        <hr>

        <div>
          <input class="form-control mb-2" id="email" placeholder="Email">
          <input class="form-control mb-2" id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
          <button class="btn btn-info" onclick="login()">–£–≤—ñ–π—Ç–∏</button>
          <span id="loginStatus" class="status"></span>
        </div>
      </div>
    </div>

    <div id="userInfo" class="alert alert-secondary" style="display:none;"></div>

    <button id="logoutBtn" class="btn btn-danger mb-3" style="display:none;" onclick="logout()">–í–∏–π—Ç–∏</button>

    <!-- ü§ñ –ë–ª–æ–∫ –∑–∞–ø–∏—Ç–∞–Ω—å —Ç–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π -->
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">–ó–∞–ø–∏—Ç–∞–Ω–Ω—è –∞–≥–µ–Ω—Ç—É</h5>

        <div class="input-group mb-3">
          <input class="form-control" id="question" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è">
          <button class="btn btn-outline-secondary" onclick="send()">–ó–∞–ø–∏—Ç–∞—Ç–∏</button>
        </div>

        <div class="response-box" id="response">–¢—É—Ç –±—É–¥–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∞–≥–µ–Ω—Ç–∞...</div>
        <div id="wait-status" class="mt-2 text-secondary" style="display:none;">‚è≥ –û—á—ñ–∫—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å...</div>
        <button id="play-audio-btn" class="btn btn-outline-primary mt-2" style="display:none;" onclick="playAudio()">üîä –í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</button>
        <audio id="audio-player" src="" style="display:none;"></audio>

      </div>
    </div>
  </div>

  <script>
    const poolData = {
      UserPoolId: 'eu-central-1_pn4F9Ot4u',
      ClientId: '2q4umqf51u61cofdlcthhr7foj'
    };

    const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);

    function register() {
      const email = document.getElementById('reg_email').value;
      const password = document.getElementById('reg_password').value;
      const attributeList = [new AmazonCognitoIdentity.CognitoUserAttribute({Name: 'email', Value: email})];

      userPool.signUp(email, password, attributeList, null, (err, result) => {
        document.getElementById('registerStatus').innerText = err ? '‚ùå ' + err.message : '‚úÖ –ó–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ email.';
      });
    }

    function confirmEmail() {
      const user = new AmazonCognitoIdentity.CognitoUser({Username: document.getElementById('confirm_email').value, Pool: userPool});
      user.confirmRegistration(document.getElementById('confirm_code').value, true, (err, result) => {
        document.getElementById('confirmStatus').innerText = err ? '‚ùå ' + err.message : '‚úÖ Email –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ!';
      });
    }

    function login() {
      const user = new AmazonCognitoIdentity.CognitoUser({Username: document.getElementById('email').value, Pool: userPool});
      const authData = new AmazonCognitoIdentity.AuthenticationDetails({Username: document.getElementById('email').value, Password: document.getElementById('password').value});

      user.authenticateUser(authData, {
        onSuccess: session => {
          localStorage.setItem('token', session.getIdToken().getJwtToken());
          localStorage.setItem('userEmail', session.getIdToken().payload.email);
          document.getElementById('loginStatus').innerText = '‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ';
          document.getElementById('userInfo').innerText = '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: ' + session.getIdToken().payload.email;
          toggleAuth(true);
        },
        onFailure: err => document.getElementById('loginStatus').innerText = '‚ùå ' + err.message
      });
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('userEmail');
      document.getElementById('userInfo').innerText = '';
      toggleAuth(false);
    }

    function toggleAuth(isLoggedIn) {
      document.getElementById('auth-block').style.display = isLoggedIn ? 'none' : 'block';
      document.getElementById('logoutBtn').style.display = isLoggedIn ? 'block' : 'none';
      document.getElementById('userInfo').style.display = isLoggedIn ? 'block' : 'none';
      if (isLoggedIn) {
        document.getElementById('userInfo').innerText = '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: ' + localStorage.getItem('userEmail');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      const userEmail = localStorage.getItem('userEmail');
      if (token && userEmail) {
        toggleAuth(true);
      }
    });

    async function send() {
      const token = localStorage.getItem('token');
      const responseDiv = document.getElementById('response');

      try {
        const res = await fetch('https://70qflf9mz1.execute-api.eu-central-1.amazonaws.com/ask', {
          method: 'POST',
          headers: {'Content-Type': 'application/json', ...(token && {'Authorization': 'Bearer ' + token})},
          body: JSON.stringify({question: document.getElementById('question').value})
        });

        const data = await res.json();
        responseDiv.innerText = data.answer || '–ù–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ';
      } catch (err) {
        responseDiv.innerText = '‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞: ' + err.message;
      }
    }

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –¥–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è base64 —É Blob —Ç–∞ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
let audioBlob = null;

function playAudio() {
  if (audioBlob) {
    const url = URL.createObjectURL(audioBlob);
    const audio = document.getElementById('audio-player');
    audio.src = url;
    audio.style.display = 'block';
    audio.play();
  }
}

async function send() {
  const token = localStorage.getItem('token');
  const responseDiv = document.getElementById('response');
  const waitStatus = document.getElementById('wait-status');
  const playBtn = document.getElementById('play-audio-btn');
  const audioElem = document.getElementById('audio-player');
  audioElem.pause();
  audioElem.style.display = 'none';
  playBtn.style.display = 'none';
  responseDiv.innerText = '';
  waitStatus.style.display = 'block';

  try {
    const res = await fetch('https://70qflf9mz1.execute-api.eu-central-1.amazonaws.com/ask', {
      method: 'POST',
      headers: {'Content-Type': 'application/json', ...(token && {'Authorization': 'Bearer ' + token})},
      body: JSON.stringify({question: document.getElementById('question').value})
    });

    const data = await res.json();
    waitStatus.style.display = 'none';

    responseDiv.innerText = data.answer || '–ù–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ';

    if (data.audio_base64) {
      // –î–µ–∫–æ–¥—É—î–º–æ base64 —É Blob
      const binary = atob(data.audio_base64);
      const array = [];
      for (let i = 0; i < binary.length; i++) {
        array.push(binary.charCodeAt(i));
      }
      audioBlob = new Blob([new Uint8Array(array)], { type: 'audio/mp3' });
      playBtn.style.display = 'inline-block';
    } else {
      playBtn.style.display = 'none';
      audioBlob = null;
    }
  } catch (err) {
    waitStatus.style.display = 'none';
    responseDiv.innerText = '‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞: ' + err.message;
    playBtn.style.display = 'none';
    audioBlob = null;
  }
}

// –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
document.getElementById('question').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});    
  </script>
</body>
</html>
